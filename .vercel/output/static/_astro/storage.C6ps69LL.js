const P="LinguaVaultDB";const a={CURRICULUMS:"curriculums",PROGRESS:"progress",SETTINGS:"settings"};let u=null;async function p(){return u||new Promise((e,s)=>{const t=indexedDB.open(P,1);t.onerror=()=>{console.error("Failed to open LinguaVault database:",t.error),s(t.error)},t.onsuccess=()=>{u=t.result,e(u)},t.onupgradeneeded=r=>{const o=r.target.result;if(!o.objectStoreNames.contains(a.CURRICULUMS)){const n=o.createObjectStore(a.CURRICULUMS,{keyPath:"id"});n.createIndex("targetLanguage","meta.targetLanguageCode",{unique:!1}),n.createIndex("createdAt","createdAt",{unique:!1})}o.objectStoreNames.contains(a.PROGRESS)||o.createObjectStore(a.PROGRESS,{keyPath:"curriculumId"}).createIndex("lastAccessedAt","lastAccessedAt",{unique:!1}),o.objectStoreNames.contains(a.SETTINGS)||o.createObjectStore(a.SETTINGS,{keyPath:"id"})}})}async function i(){return u||p()}async function w(e){const s=await i();return new Promise((t,r)=>{const c=s.transaction(a.CURRICULUMS,"readwrite").objectStore(a.CURRICULUMS).put(e);c.onsuccess=()=>t(),c.onerror=()=>r(c.error)})}async function b(e){const s=await i();return new Promise((t,r)=>{const c=s.transaction(a.CURRICULUMS,"readonly").objectStore(a.CURRICULUMS).get(e);c.onsuccess=()=>t(c.result),c.onerror=()=>r(c.error)})}async function U(){const e=await i();return new Promise((s,t)=>{const n=e.transaction(a.CURRICULUMS,"readonly").objectStore(a.CURRICULUMS).getAll();n.onsuccess=()=>s(n.result||[]),n.onerror=()=>t(n.error)})}async function O(e){const s=await i();return new Promise((t,r)=>{const o=s.transaction([a.CURRICULUMS,a.PROGRESS],"readwrite");o.objectStore(a.CURRICULUMS).delete(e),o.objectStore(a.PROGRESS).delete(e),o.oncomplete=()=>t(),o.onerror=()=>r(o.error)})}async function E(e){return await b(e)!==void 0}async function S(e){const s=await i();return new Promise((t,r)=>{const c=s.transaction(a.PROGRESS,"readwrite").objectStore(a.PROGRESS).put(e);c.onsuccess=()=>t(),c.onerror=()=>r(c.error)})}async function C(e){const s=await i();return new Promise((t,r)=>{const c=s.transaction(a.PROGRESS,"readonly").objectStore(a.PROGRESS).get(e);c.onsuccess=()=>t(c.result),c.onerror=()=>r(c.error)})}async function y(){const e=await i();return new Promise((s,t)=>{const n=e.transaction(a.PROGRESS,"readonly").objectStore(a.PROGRESS).getAll();n.onsuccess=()=>s(n.result||[]),n.onerror=()=>t(n.error)})}async function v(e){const s=new Date().toISOString(),t=s.split("T")[0],r={curriculumId:e.id,lessonProgress:{},moduleProgress:{},topicProgress:{},overallProgress:0,streakDays:0,currentStreak:{count:0,lastActiveDate:t},lastAccessedAt:s,totalTimeSpentMinutes:0,startedAt:s};return e.modules.forEach((o,n)=>{r.moduleProgress[o.id]={moduleId:o.id,status:n===0?"available":"locked",completedTopics:0,totalTopics:o.topics.length,completionPercentage:0},o.topics.forEach((c,m)=>{const d=n===0&&m===0;r.topicProgress[c.id]={topicId:c.id,status:d?"available":"locked",completedLessons:0,totalLessons:c.lessons.length,completionPercentage:0},c.lessons.forEach((g,R)=>{const I=d&&R===0;r.lessonProgress[g.id]={lessonId:g.id,status:I?"available":"locked",attempts:0,exerciseResults:{},timeSpentMinutes:0}})})}),await S(r),r}const f="user-settings";async function T(){const e=await i();return new Promise((s,t)=>{const n=e.transaction(a.SETTINGS,"readonly").objectStore(a.SETTINGS).get(f);n.onsuccess=()=>{n.result?s(n.result.settings):s({fontSize:"medium",audioSpeed:1,autoPlayAudio:!0,showPronunciation:!0,dailyGoalMinutes:15,notificationsEnabled:!1})},n.onerror=()=>t(n.error)})}async function L(e){const s=await i();return new Promise((t,r)=>{const c=s.transaction(a.SETTINGS,"readwrite").objectStore(a.SETTINGS).put({id:f,settings:e});c.onsuccess=()=>t(),c.onerror=()=>r(c.error)})}async function G(){const[e,s,t]=await Promise.all([U(),y(),T()]);return{version:"1.0.0",exportedAt:new Date().toISOString(),curriculums:e,progress:s,settings:t}}async function N(e,s={merge:!0}){const t={imported:0,skipped:0,errors:[]};for(const r of e.curriculums)try{if(await E(r.id)&&!s.overwrite&&!s.merge){t.skipped++;continue}await w(r),t.imported++}catch(o){t.errors.push(`Failed to import curriculum ${r.id}: ${o}`)}for(const r of e.progress)try{const o=await C(r.curriculumId);if(o&&s.merge){const n=A(o,r);await S(n)}else await S(r)}catch(o){t.errors.push(`Failed to import progress for ${r.curriculumId}: ${o}`)}return e.settings&&await L(e.settings),t}function A(e,s){const t={...e};s.overallProgress>e.overallProgress&&(t.overallProgress=s.overallProgress),s.streakDays>e.streakDays&&(t.streakDays=s.streakDays);for(const[r,o]of Object.entries(s.lessonProgress)){const n=e.lessonProgress[r];!n||o.status==="completed"?t.lessonProgress[r]=o:o.bestScore&&(!n.bestScore||o.bestScore>n.bestScore)&&(t.lessonProgress[r]={...n,bestScore:o.bestScore})}return t}async function _(){const e=await i();return new Promise((s,t)=>{const r=e.transaction([a.CURRICULUMS,a.PROGRESS,a.SETTINGS],"readwrite");r.objectStore(a.CURRICULUMS).clear(),r.objectStore(a.PROGRESS).clear(),r.objectStore(a.SETTINGS).clear(),r.oncomplete=()=>s(),r.onerror=()=>t(r.error)})}async function j(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return{used:e.usage||0,available:e.quota||0}}return{used:0,available:0}}const l={ACTIVE_CURRICULUM:"lv_active_curriculum",LAST_LESSON:"lv_last_lesson",ONBOARDING_STATE:"lv_onboarding_state",UI_PREFERENCES:"lv_ui_preferences",FIRST_VISIT:"lv_first_visit"};function M(){return typeof window>"u"?null:localStorage.getItem(l.ACTIVE_CURRICULUM)}function D(e){typeof window>"u"||localStorage.setItem(l.ACTIVE_CURRICULUM,e)}function h(){if(typeof window>"u")return null;const e=localStorage.getItem(l.LAST_LESSON);if(!e)return null;try{return JSON.parse(e)}catch{return null}}function k(e){if(typeof window>"u")return;const s={...e,timestamp:new Date().toISOString()};localStorage.setItem(l.LAST_LESSON,JSON.stringify(s))}function q(){typeof window>"u"||Object.values(l).forEach(e=>{localStorage.removeItem(e)})}export{C as a,S as b,h as c,U as d,G as e,O as f,b as g,_ as h,N as i,q as j,j as k,p as l,y as m,M as n,D as o,w as p,v as q,k as s};
